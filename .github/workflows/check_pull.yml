name: PR validation

on:
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-slim

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
   
      - name: Validate commit structure and file output
        run: |
          # Filter out merge commits
          COMMITS=$(git rev-list origin/main..HEAD | while read COMMIT; do
            TITLE=$(git log -1 --pretty=%s $COMMIT)
            if [[ "$TITLE" != Merge* ]]; then
              echo $COMMIT
            fi
          done)

          # Define expected structure and outputs (in reverse order as shown by git log)
          EXPECTED_COMMITS=(
            "{\"title\":\"chore(main): order my pizza\",\"file\":\"src/main.ps1\"}"
            "{\"title\":\"refact(main): extract Get-Pizza\",\"file\":\"src/main.ps1\"}"
            "{\"title\":\"chore(main): call Submit-Order with custom pizza\",\"file\":\"src/main.ps1\"}"
            "{\"title\":\"feat(order): implement Submit-Order\",\"file\":\"src/order.ps1\"}"
          )

          i=0
          for COMMIT in $COMMITS; do
            TITLE=$(git log -1 --pretty=%s $COMMIT)
            FILE=$(git diff-tree --no-commit-id --name-only -r $COMMIT)

            EXPECTED_TITLE=$(echo ${EXPECTED_COMMITS[$i]} | jq -r .title)
            EXPECTED_FILE=$(echo ${EXPECTED_COMMITS[$i]} | jq -r .file)

            if [ "$TITLE" != "$EXPECTED_TITLE" ]; then
              echo "Unexpected commit title: $TITLE"
              echo "Expected: $EXPECTED_TITLE"
              exit 1
            fi

            if [ "$FILE" != "$EXPECTED_FILE" ]; then
              echo "Unexpected file changed in commit $TITLE: $FILE"
              echo "Expected: $EXPECTED_FILE"
              exit 1
            fi

            i=$((i+1))
          done